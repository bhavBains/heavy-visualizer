var audio_analysis = {
"segments":[{"start":0.00000, "duration":0.49469, "confidence":1.000, "loudness_start":-60.000, "loudness_max_time":0.03133, "loudness_max":-15.084, "pitches":[0.006, 0.041, 0.007, 0.010, 0.016, 0.054, 1.000, 0.030, 0.008, 0.006, 0.013, 0.005], "timbre":[33.189, -17.584, -48.494, 46.152, 75.309, 153.949, -7.804, 26.707, -11.141, 74.598, 102.016, -22.742]}, {"start":0.49469, "duration":0.47546, "confidence":1.000, "loudness_start":-36.204, "loudness_max_time":0.01161, "loudness_max":-12.368, "pitches":[0.021, 0.046, 0.017, 0.019, 0.029, 0.082, 1.000, 0.050, 0.019, 0.016, 0.022, 0.016], "timbre":[40.282, 13.119, 36.305, 114.235, 97.965, -67.018, -28.116, 0.576, 9.920, -27.102, -20.557, 9.529]}, {"start":0.97016, "duration":0.31791, "confidence":1.000, "loudness_start":-33.517, "loudness_max_time":0.01646, "loudness_max":-14.604, "pitches":[0.003, 0.008, 0.003, 0.004, 0.041, 0.013, 0.051, 0.011, 0.019, 1.000, 0.025, 0.005], "timbre":[40.128, -25.045, -30.182, 53.893, 62.955, -39.410, -65.590, 0.233, 17.763, -19.026, -11.399, -5.479]}, {"start":1.28807, "duration":0.15764, "confidence":0.239, "loudness_start":-29.909, "loudness_max_time":0.01800, "loudness_max":-25.608, "pitches":[0.009, 0.016, 0.007, 0.005, 0.037, 0.015, 0.149, 0.019, 0.032, 1.000, 0.066, 0.008], "timbre":[30.541, -28.840, 19.838, 18.389, 35.749, -55.093, -70.727, -1.894, 7.775, -11.003, 8.896, -9.186]}, {"start":1.44571, "duration":0.31918, "confidence":1.000, "loudness_start":-34.498, "loudness_max_time":0.01445, "loudness_max":-12.839, "pitches":[0.033, 1.000, 0.025, 0.008, 0.007, 0.023, 0.045, 0.009, 0.025, 0.049, 0.009, 0.011], "timbre":[40.895, 3.496, -1.927, 80.859, 83.876, -46.716, -58.338, 11.325, 30.689, -16.050, -16.833, -2.829]}, {"start":1.76490, "duration":0.13914, "confidence":0.378, "loudness_start":-31.370, "loudness_max_time":0.00827, "loudness_max":-25.282, "pitches":[0.056, 1.000, 0.056, 0.008, 0.018, 0.018, 0.038, 0.008, 0.048, 0.472, 0.049, 0.012], "timbre":[31.197, -30.020, 30.446, 19.951, 72.013, -60.645, -36.863, -9.358, 7.107, -5.808, -3.157, 3.565]}, {"start":1.90404, "duration":0.49451, "confidence":1.000, "loudness_start":-32.181, "loudness_max_time":0.03019, "loudness_max":-14.234, "pitches":[0.011, 0.062, 0.013, 0.011, 0.019, 0.047, 1.000, 0.029, 0.011, 0.052, 0.015, 0.004], "timbre":[36.928, -39.004, -33.461, 70.323, 56.640, 35.903, -36.715, 21.571, 0.611, 3.973, 23.886, -17.491]}, {"start":2.39855, "duration":0.47510, "confidence":1.000, "loudness_start":-34.743, "loudness_max_time":0.01327, "loudness_max":-12.812, "pitches":[0.016, 0.094, 0.013, 0.013, 0.021, 0.057, 1.000, 0.039, 0.018, 0.050, 0.017, 0.009], "timbre":[40.546, 4.742, 39.111, 111.738, 99.930, -52.924, -23.020, 3.107, 0.151, -31.670, -16.368, 4.018]}, {"start":2.87365, "duration":0.47519, "confidence":1.000, "loudness_start":-32.373, "loudness_max_time":0.01433, "loudness_max":-14.191, "pitches":[0.010, 0.033, 0.010, 0.011, 0.060, 0.028, 0.123, 0.026, 0.059, 1.000, 0.037, 0.014], "timbre":[38.736, -28.873, -32.499, 80.610, 61.332, -45.566, -65.318, 5.973, 14.839, -25.156, -11.755, -7.100]}, {"start":3.34884, "duration":0.32050, "confidence":1.000, "loudness_start":-35.373, "loudness_max_time":0.01583, "loudness_max":-12.776, "pitches":[0.031, 1.000, 0.028, 0.008, 0.007, 0.019, 0.038, 0.010, 0.027, 0.053, 0.006, 0.009], "timbre":[40.612, 4.694, 3.495, 76.177, 80.326, -54.299, -56.483, 13.305, 25.905, -13.933, -13.071, -1.888]}, {"start":3.66934, "duration":0.15574, "confidence":0.201, "loudness_start":-30.554, "loudness_max_time":0.01243, "loudness_max":-25.299, "pitches":[0.046, 1.000, 0.044, 0.008, 0.013, 0.018, 0.025, 0.007, 0.048, 0.613, 0.049, 0.010], "timbre":[31.028, -28.534, 32.266, 21.129, 57.408, -63.534, -32.995, 3.984, 5.000, -11.734, 5.315, 9.270]}, {"start":3.82508, "duration":0.47737, "confidence":1.000, "loudness_start":-32.612, "loudness_max_time":0.01384, "loudness_max":-14.791, "pitches":[0.011, 0.055, 0.011, 0.010, 0.018, 0.046, 1.000, 0.027, 0.011, 0.044, 0.018, 0.005], "timbre":[38.334, -38.601, -42.380, 70.869, 42.265, -45.988, -55.328, 2.822, 2.120, -20.452, -18.068, -9.067]}, {"start":4.30245, "duration":0.32422, "confidence":1.000, "loudness_start":-35.923, "loudness_max_time":0.01596, "loudness_max":-11.212, "pitches":[0.014, 0.064, 0.008, 0.007, 0.010, 0.028, 1.000, 0.021, 0.014, 0.035, 0.013, 0.008], "timbre":[42.227, 19.454, 48.475, 103.860, 101.302, -61.519, -28.677, -3.530, 5.673, -21.381, -8.441, 8.706]}, {"start":4.62667, "duration":0.15111, "confidence":0.034, "loudness_start":-26.945, "loudness_max_time":0.00851, "loudness_max":-23.657, "pitches":[0.009, 0.057, 0.007, 0.006, 0.015, 0.059, 1.000, 0.040, 0.014, 0.041, 0.014, 0.005], "timbre":[31.796, 5.437, 67.746, 51.783, 86.078, -79.653, 1.970, 10.939, -1.535, -2.383, -9.784, -12.956]}, {"start":4.77778, "duration":0.32014, "confidence":1.000, "loudness_start":-32.039, "loudness_max_time":0.01656, "loudness_max":-13.363, "pitches":[0.004, 0.017, 0.010, 0.010, 0.044, 0.013, 0.053, 0.012, 0.031, 1.000, 0.024, 0.007], "timbre":[40.262, -26.929, -39.268, 65.175, 58.222, -42.156, -67.737, 8.113, 14.612, -24.940, -12.992, -8.213]}]}

var camera, scene, renderer;
var boxGeometry, boxMaterial, mesh, controls, fog;

var properties = {
    box: {
        color: '#35a7af',
        quantity: 10,
        x_size: 5,
        y_size: 3,
        z_size: 4,
        wireframe: false,
    },
    circle: {
        color: '#eee',
        quantity: 3,
        x_size: 6,
        y_size: 2,
        z_size: 4,
        wireframe: true,
    }
}

var position_in_segments = 1,
    loudness,
    duration = 0,
    boxes = [],
    box,
    circle,
    urls = [],
    skyTextures = [],
    cubeMap,
    circles = [];

function loadFirstBeat () {
  loudness = audio_analysis.segments[0].loudness_start;
}

function playBeat() {
  if (position_in_segments >= audio_analysis.segments.length - 1) {
    return;
  }
  // change value
  let x = loudness/(-60);
  musicImpact(x);
  // load next beat
  loudness = audio_analysis.segments[position_in_segments].loudness_start;
  duration = audio_analysis.segments[position_in_segments].duration;
  duration *= 1000;
  position_in_segments++;
  // console.log(duration);
  setTimeout(playBeat, duration);
}

function init(properties) {

  camera = new THREE.PerspectiveCamera(100, window.innerWidth / window.innerHeight, 1, 9000);
  camera.position.z = 1400;

  controls = new THREE.TrackballControls(camera, document.getElementById('threeCanvas'));
  controls.addEventListener('change', sceneRender);

  scene = new THREE.Scene();
  // scene.fog = new THREE.Fog( 0x71757a, 10, 200 );
  // scene.fog = new THREE.FogExp2( 0x71757a, 0.0007 );





  // var names = ["posz","negz","posy","negy","posx","negx"];

  // var i;
  // for (i = 0; i < 6; i++) {
  //   urls[i] = "textures/" + names[i] + ".jpg";
  //   skyTextures[i] = THREE.TextureLoader(urls[i]);
  // }

  // var skyMaterials = [];
  // skyMaterials.push(new THREE.MeshBasicMaterial({ map: skyTextures[0] }));
  // skyMaterials.push(new THREE.MeshBasicMaterial({ map: skyTextures[1] }));
  // skyMaterials.push(new THREE.MeshBasicMaterial({ map: skyTextures[2] }));
  // skyMaterials.push(new THREE.MeshBasicMaterial({ map: skyTextures[3] }));
  // skyMaterials.push(new THREE.MeshBasicMaterial({ map: skyTextures[4] }));
  // skyMaterials.push(new THREE.MeshBasicMaterial({ map: skyTextures[5] }));

  // console.log(urls);
  // dome = new THREE.Mesh( new THREE.BoxGeometry( 9000, 9000, 9000, 1, 1,1, skyMaterials,true), new THREE.MeshBasicMaterial() );
  // scene.add(dome);

  // cubeMap = new THREE.CubeTextureLoader(urls);


  // var light = new THREE.PointLight(0xffffff);
  // light.position.set(60, 0, 20);
  // scene.add(light);
  // var lightAmb = new THREE.AmbientLight(0xffffff);
  // scene.add(lightAmb);



    // console.log(boxes);

    makeBox();

    makeCircle();

  /////// GUI //////////////
  var gui = new dat.GUI({ autoPlace: false, preset: properties });

  var customContainer = document.getElementById('my-gui-container');
  customContainer.appendChild(gui.domElement);
  gui.remember(properties);

  var boxColor = gui.addColor(properties.box, 'color').name('Color').listen();
  var boxQuantity = gui.add(properties.box, 'quantity', 0, 15);
  var boxWireframe = gui.add(properties.box, 'wireframe');

  var circleColor = gui.addColor(properties.circle, 'color').name('Color').listen();
  var circleQuantity = gui.add(properties.circle, 'quantity', 0, 15);
  var circleWireframe = gui.add(properties.circle, 'wireframe');


  boxColor.onChange(function(value) {
    box.material.color.setHex( value.replace("#", "0x") );
  });

  boxQuantity.onChange(function(value) {
    boxes.forEach(function(box) {
      scene.remove(box);
    });
    makeBox(value);
  });

  boxWireframe.onChange(function(value) {
    boxes.forEach(function(box) {
      scene.remove(box);
    });
    makeBox(box.quantity);
  });

  circleColor.onChange(function(value)  {
    circle.material.color.setHex( value.replace("#", "0x") );
  });

  circleQuantity.onChange(function(value) {
    circles.forEach(function(circle) {
      scene.remove(circle);
    });
    makeCircle(value);
  });

  circleWireframe.onChange(function(value) {
    circles.forEach(function(circle) {
      scene.remove(circle);
    });
    makeCircle(circle.quantity);
  });


   // gui.add(obj, 'displayOutline');
  // gui.add(obj, 'explode');
  // gui.add(obj, 'maxSize').min(-10).max(10).step(0.25);
  // gui.add(obj, 'height').step(5); // Increment amount
  // // Choose from accepted values
  // gui.add(obj, 'type', [ 'one', 'two', 'three' ] );
  // // Choose from named values
  // gui.add(obj, 'speed', { Stopped: 0, Slow: 0.1, Fast: 5 } );



  gui.open();



    renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // universe begins, loads loudness for first instance.
    loadFirstBeat();
    playBeat();
    // music started


}


function wireFrame() {
  box.wireframe = value;
  animate();
}


function makeBox() {
      // BOX /////////////////////
    var realXsize = properties.box.x_size * 100;
    var realYsize = properties.box.y_size * 100;
    var realZsize = properties.box.z_size * 100;

    boxGeometry = new THREE.BoxGeometry(realXsize, realYsize, realZsize);

    boxMaterial = new THREE.MeshBasicMaterial({
        color: properties.box.color,
        wireframe: properties.box.wireframe,
    });

    for (var i = 0; i < properties.box.quantity; i++) {
        box = new THREE.Mesh(boxGeometry, boxMaterial);
        box.position.x = (Math.random() - 0.5) * 3000;
        box.position.y = (Math.random() - 0.5) * 1200;
        box.position.z = (Math.random() - 0.5) * 500;
        scene.add(box);
        // console.log(box);
        boxes.push(box);
    }
}

function makeCircle() {
      // CIRCLE /////////////////
    properties.circle.realXsizeCircle = properties.circle.x_size * 100;
    properties.circle.realYsizeCircle = properties.circle.y_size * 100;
    properties.circle.realZsizeCircle = properties.circle.z_size * 100;


    circleGeometry = new THREE.CircleGeometry(properties.circle.realXsizeCircle, properties.circle.realYsizeCircle, properties.circle.realZsizeCircle);

    circleMaterial = new THREE.MeshBasicMaterial({
        color: properties.circle.color,
        wireframe: properties.circle.wireframe,
    });
    for (var i = 0; i < properties.circle.quantity; i++) {
        circle = new THREE.Mesh(circleGeometry, circleMaterial);
        circle.position.x = (Math.random() - 0.5) * 3000;
        circle.position.y = (Math.random() - 0.5) * 1200;
        circle.position.z = (Math.random() - 0.5) * 500;
        scene.add(circle);
        circles.push(circle);

    }
}


function animate(properties) {
    requestAnimationFrame(animate);
    controls.update();
    sceneRender();
}

function sceneRender() {
    // console.log(renderer);
    renderer.render(scene, camera);
}

// on load render scene
document.addEventListener('DOMContentLoaded', function() {
    init(properties);
    animate(properties);
    sceneRender();
});

// on music play, render scene

// $(function() {

    function musicImpact(x) {
  // properties.circle.realXsizeCircle += x * 500;
    // console.log("X is:" + x);
    // console.log("Properties circles size:" + properties.circle.x_size);


    boxes.forEach(function(box){

      box.scale.set(x, x, x)
      // circles.scale.set(x, x, x)
    })
}


$(function(){

  $('#my-gui-container').on('click', function(e) {


    sceneRender();

  });

});
// });



    // properties.circle.realXsizeCircle = properties.circle.x_size + x * 900;

    // Object3D.scale(x, 1, 1);
    // mesh.rotation.x += + x;
    // mesh.rotation.y += 0.02;
    // animate(properties);

